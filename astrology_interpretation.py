from typing import Dict, Any, List, Optional
import math

# ====================================================================
# ثابت‌های نگاشت (CONSTANTS) - برای تبدیل از انگلیسی به فارسی
# ====================================================================

# فهرست سیارات و نقاط مورد استفاده
PLANETS = ['sun', 'moon', 'mercury', 'venus', 'mars', 'jupiter', 'saturn', 'uranus', 'neptune', 'pluto', 'true_node', 'part_of_fortune']

# نگاشت نام‌های سیارات و نقاط
PLANETS_MAP = {
    'SUN': 'خورشید', 'MOON': 'ماه', 'MERCURY': 'عطارد', 'VENUS': 'زهره', 'MARS': 'مریخ',
    'JUPITER': 'مشتری', 'SATURN': 'زحل', 'URANUS': 'اورانوس', 'NEPTUNE': 'نپتون', 'PLUTO': 'پلوتون',
    'TRUE_NODE': 'گره شمالی', 'PART_OF_FORTUNE': 'سهم سعادت'
}

# نگاشت نام‌های برج‌های فلکی
SIGNS_MAP = {
    'ARIES': 'حمل', 'TAURUS': 'ثور', 'GEMINI': 'جوزا', 'CANCER': 'سرطان', 'LEO': 'اسد', 
    'VIRGO': 'سنبله', 'LIBRA': 'میزان', 'SCORPIO': 'عقرب', 'SAGITTARIUS': 'قوس', 
    'CAPRICORN': 'جدی', 'AQUARIUS': 'دلو', 'PISCES': 'حوت'
}

# نگاشت نام‌های زوایا (Aspects)
ASPECTS_MAP = {
    'CONJUNCTION': 'اتصال (0°)',
    'SEXTILE': 'تثلیث کوچک (60°)',
    'SQUARE': 'تربیع (90°)',
    'TRINE': 'تثلیث (120°)',
    'OPPOSITION': 'مقابله (180°)'
}

# نگاشت عناصر و کیفیت‌ها
ELEMENT_MAP = {'Fire': 'آتش', 'Earth': 'خاک', 'Air': 'هوا', 'Water': 'آب'}
QUALITY_MAP = {'Cardinal': 'بنیادی', 'Fixed': 'ثابت', 'Mutable': 'متغیر'}

# ====================================================================
# توابع کمکی
# ====================================================================

def get_sign_name(degree: float) -> str:
    """محاسبه برج فلکی بر اساس درجه (0-360) و بازگرداندن نام فارسی آن."""
    sign_index = int(degree // 30)
    sign_names_en = list(SIGNS_MAP.keys())
    sign_name_en = sign_names_en[sign_index]
    return SIGNS_MAP[sign_name_en]

def get_degree_in_sign(degree: float) -> str:
    """محاسبه درجه دقیق سیاره در برج (مثلاً '25° 30'' ')."""
    deg_in_sign = degree % 30
    minutes = (deg_in_sign - int(deg_in_sign)) * 60
    return f"{int(deg_in_sign)}° {int(minutes)}'"

# ====================================================================
# بانک اطلاعاتی تفسیری کامل (Fully Populated Interpretation Database)
# **این بخش شامل همان دیکشنری‌های عمیق درخواستی شماست.**
# ====================================================================

# 1. تفسیر آسندانت (شخصیت ظاهری)
ASCENDANT_INTERPRETATIONS: Dict[str, str] = {
    'ARIES': '*شخصیت ظاهری شما پرانرژی، جسور و مستقیم است. با اعتماد به نفس و استقلال عمل می‌کنید و دوست دارید پیشگام باشید.*',
    'TAURUS': '*شخصیت ظاهری آرام، استوار و محتاط است. شما به دنبال ثبات و امنیت هستید و اغلب کند و متفکرانه عمل می‌کنید.*',
    'GEMINI': '*شخصیت ظاهری شما با کنجکاوی، پرحرفی و هوش زیاد شناخته می‌شود. بسیار اجتماعی و متغیر هستید و نیاز به تنوع دارید.*',
    'CANCER': '*شخصیت ظاهری شما حساس، دلسوز و محافظه‌کار است. شما با ملایمت با دنیا برخورد می‌کنید و امنیت عاطفی برایتان اولویت دارد.*',
    'LEO': '*شخصیت ظاهری شما مغرور، نمایشی و باوقار است. اعتماد به نفس بالا و نیاز به دیده شدن و رهبری، ویژگی‌های بارز شماست.*',
    'VIRGO': '*شخصیت ظاهری شما متواضع، تحلیل‌گر و کمال‌گرا است. شما با دقت و توجه به جزئیات با جهان برخورد می‌کنید و دوست دارید مفید باشید.*',
    'LIBRA': '*شخصیت ظاهری دلپذیر، صلح‌جو و اجتماعی است. شما به دنبال تعادل، هماهنگی و روابط خوب هستید و جذابیت زیادی دارید.*',
    'SCORPIO': '*شخصیت ظاهری شما مرموز، عمیق و شدید است. شما با قدرتی پنهان با جهان تعامل می‌کنید و به سختی به دیگران اجازه ورود می‌دهید.*',
    'SAGITTARIUS': '*شخصیت ظاهری شما خوش‌بین، جستجوگر و فلسفی است. شما به دنبال حقیقت، سفر و آزادی هستید و روحیه ماجراجو دارید.*',
    'CAPRICORN': '*شخصیت ظاهری جدی، مسئولیت‌پذیر و بلندپرواز است. شما با نظم و خویشتن‌داری به دنیا نگاه می‌کنید و هدف‌مند هستید.*',
    'AQUARIUS': '*شخصیت ظاهری غیرمعمول، روشنفکر و مستقل است. شما به دنبال تغییرات اجتماعی، دوستی‌های خاص و آزادی فکری هستید.*',
    'PISCES': '*شخصیت ظاهری رؤیایی، شهودی و همدل است. شما حساسیت بالایی دارید و ممکن است در زندگی روزمره کمی سردرگم به نظر برسید.*',
}

# 2. تفسیر سیارات در برج‌ها (Planets in Signs)
PLANET_IN_SIGN_INTERPRETATIONS: Dict[str, Dict[str, str]] = {
    # --- خورشید (هویت، اراده) ---
    'sun': {
        'ARIES': '♈ *خورشید در حمل:* هویت شما در استقلال، جسارت و عمل آغازگرانه تعریف می‌شود. با اعتماد به نفس زیاد و انگیزه‌ی بالا زندگی می‌کنید.',
        'TAURUS': '♉ *خورشید در ثور:* هویت شما بر اساس ثبات، امنیت مالی و ارزش‌های محسوس بنا شده است. آرام و متمرکز به دنبال لذت‌های حسی هستید.',
        'GEMINI': '♊ *خورشید در جوزا:* هویت شما در تنوع، برقراری ارتباط و یادگیری پیوسته است. ذهنی کنجکاو و هویتی انعطاف‌پذیر دارید.',
        'CANCER': '♋ *خورشید در سرطان:* هویت شما به ریشه‌ها، خانواده و امنیت عاطفی گره خورده است. فردی دلسوز و محافظه‌کار هستید.',
        'LEO': '♌ *خورشید در اسد:* هویت شما با غرور، رهبری و نیاز به توجه گره خورده است. بسیار خلاق و مرکزگرا هستید.',
        'VIRGO': '♍ *خورشید در سنبله:* هویت شما در خدمت، کارایی و توجه به جزئیات است. فردی متواضع، تحلیل‌گر و کمال‌گرا هستید.',
        'LIBRA': '♎ *خورشید در میزان:* هویت شما در تعادل، روابط یک به یک و جستجوی عدالت تعریف می‌شود. فردی اجتماعی و صلح‌جو هستید.',
        'SCORPIO': '♏ *خورشید در عقرب:* هویت شما در عمق، تحول و قدرت درونی ریشه دارد. مرموز، شدید و قادر به بازسازی خود هستید.',
        'SAGITTARIUS': '♐ *خورشید در قوس:* هویت شما در جستجوی حقیقت، فلسفه و ماجراجویی است. فردی خوش‌بین، باایمان و عاشق آزادی هستید.',
        'CAPRICORN': '♑ *خورشید در جدی:* هویت شما در جاه‌طلبی، مسئولیت‌پذیری و موفقیت اجتماعی است. فردی منظم، جدی و هدف‌مند هستید.',
        'AQUARIUS': '♒ *خورشید در دلو:* هویت شما در استقلال فکری، نوآوری و پیوندهای گروهی است. فردی انسان‌دوست، پیشرو و کمی غیرمتعارف هستید.',
        'PISCES': '♓ *خورشید در حوت:* هویت شما در همدلی، شهود و جهان‌بینی رؤیایی است. حساس، هنری و گاهی از واقعیت دور هستید.',
    },
    # --- ماه (نیازهای عاطفی، امنیت) ---
    'moon': {
        'ARIES': '♈ *ماه در حمل:* امنیت عاطفی از طریق مستقل بودن و خودگردانی تأمین می‌شود. شما واکنش‌های سریع و آتشین دارید.',
        'TAURUS': '♉ *ماه در ثور:* امنیت عاطفی در ثبات، راحتی و محیط آرام پیدا می‌شود. شما فردی وفادار و نیازمند یک پایگاه محکم هستید.',
        'GEMINI': '♊ *ماه در جوزا:* امنیت عاطفی در ارتباط، تنوع فکری و تبادل اطلاعات تأمین می‌شود. شما نیازمند صحبت کردن درباره احساسات خود هستید.',
        'CANCER': '♋ *ماه در سرطان:* امنیت عاطفی از طریق خانه، خانواده و پرورش دیگران تأمین می‌شود. بسیار حساس و مراقب هستید.',
        'LEO': '♌ *ماه در اسد:* امنیت عاطفی با دیده شدن، تأیید شدن و غرور به دست می‌آید. شما نیازمند بازی، درام و ابراز احساسات بزرگ هستید.',
        'VIRGO': '♍ *ماه در سنبله:* امنیت عاطفی از طریق مفید بودن، نظم و جزئیات تأمین می‌شود. شما به جای ابراز احساسات، عمل می‌کنید.',
        'LIBRA': '♎ *ماه در میزان:* امنیت عاطفی در هماهنگی، صلح و روابط متوازن تأمین می‌شود. شما از تنهایی گریزان هستید.',
        'SCORPIO': '♏ *ماه در عقرب:* امنیت عاطفی با عمق، راز و شدت احساسی پیدا می‌شود. شما احساسات پیچیده و شدید دارید.',
        'SAGITTARIUS': '♐ *ماه در قوس:* امنیت عاطفی از طریق جستجو، فلسفه و آزادی تأمین می‌شود. روحیه ماجراجو دارید.',
        'CAPRICORN': '♑ *ماه در جدی:* امنیت عاطفی در ساختار، دستاورد و کنترل تأمین می‌شود. شما احساسات را سرکوب می‌کنید و فردی جدی در روابط هستید.',
        'AQUARIUS': '♒ *ماه در دلو:* امنیت عاطفی در گروه، دوستی و آزادی عاطفی تأمین می‌شود. شما احساسات خود را به صورت عقلانی تحلیل می‌کنید.',
        'PISCES': '♓ *ماه در حوت:* امنیت عاطفی از طریق شهود، خیال و دلسوزی تأمین می‌شود. شما بسیار همدل و روحیه‌ای لطیف و رؤیایی دارید.',
    },
    # --- عطارد (نحوه تفکر و ارتباط) ---
    'mercury': {
        'ARIES': '♈ *عطارد در حمل:* ذهنی سریع، مستقیم و بحث‌کننده. شما بدون فیلتر حرف می‌زنید و به شروع پروژه‌های فکری جدید علاقه‌مندید.',
        'TAURUS': '♉ *عطارد در ثور:* ذهنی آرام، متمرکز و عملی. شما برای تغییر ایده زمان نیاز دارید و تفکر شما به امور ملموس و مالی مربوط است.',
        'GEMINI': '♊ *عطارد در جوزا:* ذهنی سریع، کنجکاو، منطقی و علاقه‌مند به صدها موضوع مختلف. ارتباط برقرار کننده عالی.',
        'CANCER': '♋ *عطارد در سرطان:* ذهنی که تحت تأثیر احساسات و حافظه است. شما از طریق داستان‌گویی و خاطرات ارتباط برقرار می‌کنید.',
        'LEO': '♌ *عطارد در اسد:* ذهنی خلاق، نمایشی و خودباور. شما دوست دارید ایده‌هایتان را با شور و اشتیاق ابراز کنید و به دنبال تأیید و توجه دیگران به طرز فکر خود هستید.',
        'VIRGO': '♍ *عطارد در سنبله:* ذهنی تحلیلی، جزئی‌نگر و عملگرا. شما عاشق طبقه‌بندی و حل مسئله هستید.',
        'LIBRA': '♎ *عطارد در میزان:* ذهنی که به دنبال عدالت، توازن و منطق روابط است. شما قبل از تصمیم‌گیری تمام جوانب را می‌سنجید.',
        'SCORPIO': '♏ *عطارد در عقرب:* ذهنی عمیق، کنجکاو و جستجوگر حقایق پنهان. شما به راحتی به اسرار پی می‌برید و ارتباط شما شدید است.',
        'SAGITTARIUS': '♐ *عطارد در قوس:* ذهنی که به دنبال تصویر بزرگ، فلسفه و ایده‌های بزرگ است. شما سخنگوی حقیقت هستید، اما ممکن است از جزئیات غافل شوید.',
        'CAPRICORN': '♑ *عطارد در جدی:* ذهنی ساختارمند، عملی و جاه‌طلب. شما به برنامه‌ریزی و تصمیم‌گیری‌های طولانی‌مدت علاقه دارید.',
        'AQUARIUS': '♒ *عطارد در دلو:* ذهنی مستقل، نوآور و غیرمتعارف. شما ایده‌های جدید و اجتماعی دارید و ارتباط شما عقلانی است.',
        'PISCES': '♓ *عطارد در حوت:* ذهنی شهودی، هنری و غیرمنطقی. شما از طریق تصویر و احساسات ارتباط برقرار می‌کنید و گاهی تمرکز ندارید.',
    },
    # --- زهره (عشق، ارزش‌ها) ---
    'venus': {
        'ARIES': '♈ *زهره در حمل:* شما در عشق، مستقیم، هیجان‌انگیز و کمی خودخواه هستید. سریع عاشق می‌شوید و عاشق تعقیب هستید. به دنبال شریک مستقل.*',
        'TAURUS': '♉ *زهره در ثور:* شما در عشق، وفادار، حسی و ثابت‌قدم هستید. به دنبال راحتی، زیبایی و امنیت مالی در روابط هستید.',
        'GEMINI': '♊ *زهره در جوزا:* شما در عشق، متنوع، بازیگوش و نیازمند تحریک فکری هستید. ممکن است در روابط به سرعت خسته شوید.',
        'CANCER': '♋ *زهره در سرطان:* شما در عشق، عمیقاً عاطفی، محافظه‌کار و نیازمند امنیت هستید. ارزش‌های شما با خانواده، خانه و خاطرات گره خورده است.',
        'LEO': '♌ *زهره در اسد:* شما در عشق، نمایشی، وفادار و نیازمند تحسین و توجه هستید. روابط شما باید مرکز توجه باشند.',
        'VIRGO': '♍ *زهره در سنبله:* شما در عشق، محتاط، خدمتگزار و به دنبال کمال هستید. عشق خود را با کمک عملی و توجه به جزئیات نشان می‌دهید.',
        'LIBRA': '♎ *زهره در میزان:* شما در عشق، متوازن، جذاب و به دنبال یک شریک کامل هستید. روابط برای شما هدف زندگی است.',
        'SCORPIO': '♏ *زهره در عقرب:* شما در عشق، شدید، انحصاری و نیازمند پیوند روانی عمیق هستید. به شدت حسود هستید و از سطحی بودن نفرت دارید.',
        'SAGITTARIUS': '♐ *زهره در قوس:* شما در عشق، آزاد، صادق و به دنبال شریک با دیدگاه‌های بزرگ هستید. به آزادی خود در روابط اهمیت می‌دهید.',
        'CAPRICORN': '♑ *زهره در جدی:* شما در عشق، جدی، محتاط و به دنبال روابط باثبات و طولانی‌مدت هستید. عشق را با دستاوردها و جایگاه اجتماعی می‌سنجید.',
        'AQUARIUS': '♒ *زهره در دلو:* شما در عشق، غیرمتعارف، دوستانه و به دنبال استقلال در روابط هستید. عشق را به صورت یک پیوند فکری و گروهی می‌بینید.',
        'PISCES': '♓ *زهره در حوت:* شما در عشق، رؤیایی، ایثارگر و بی‌قید و شرط هستید. تمایل به قربانی شدن در روابط دارید و عاشقانه غیرواقع‌بین هستید.',
    },
    # --- مریخ (انرژی، عمل) ---
    'mars': {
        'ARIES': '♈ *مریخ در حمل:* انرژی شما مستقیم، هیجان‌انگیز و سریع است. شما بدون فکر اقدام می‌کنید و بسیار رقابتی هستید.',
        'TAURUS': '♉ *مریخ در ثور:* انرژی شما ثابت، کند و متمرکز است. شروع عمل سخت است، اما وقتی شروع کنید، شکست‌ناپذیر هستید. برای امور مالی مبارزه می‌کنید.',
        'GEMINI': '♊ *مریخ در جوزا:* انرژی شما پراکنده، کلامی و فکری است. شما با کلمات مبارزه می‌کنید و انرژی زیادی را صرف صحبت کردن و حرکت می‌کنید.',
        'CANCER': '♋ *مریخ در سرطان:* انرژی شما دفاعی، عاطفی و متوجه خانه و خانواده است. شما به طور غریزی از چیزهایی که دوست دارید محافظت می‌کنید.',
        'LEO': '♌ *مریخ در اسد:* انرژی شما نمایشی، گرم و نیازمند تحسین است. شما برای رهبری و دیده شدن عمل می‌کنید.',
        'VIRGO': '♍ *مریخ در سنبله:* انرژی شما متوجه خدمات، کار و کمال است. شما انرژی خود را به صورت دقیق و تحلیلی برای بهبود کارایی صرف می‌کنید.',
        'LIBRA': '♎ *مریخ در میزان:* انرژی و اقدام شما حول عدالت، تعادل و روابط دیپلماتیک می‌چرخد. از درگیری آشکار دوری می‌کنید.',
        'SCORPIO': '♏ *مریخ در عقرب:* انرژی شما شدید، متمرکز و پنهان است. شما با اراده‌ای قوی و غیرقابل انعطاف عمل می‌کنید.',
        'SAGITTARIUS': '♐ *مریخ در قوس:* انرژی شما متوجه جستجوی حقیقت، سفر و آزادی است. شما برای ایدئولوژی‌های خود مبارزه می‌کنید.',
        'CAPRICORN': '♑ *مریخ در جدی:* انرژی شما ساختارمند، کنترل‌شده و جاه‌طلب است. شما با نظم و هدف عمل می‌کنید.',
        'AQUARIUS': '♒ *مریخ در دلو:* انرژی شما نوآورانه، گروهی و غیرشخصی است. شما برای آرمان‌ها و تغییرات اجتماعی عمل می‌کنید.',
        'PISCES': '♓ *مریخ در حوت:* انرژی شما منفعل، شهودی و غیرمستقیم است. شما از طریق همدلی و هنر عمل می‌کنید، اما ممکن است فاقد انگیزه باشید.',
    },
    # --- سیارات اجتماعی و نسلی (خلاصه) ---
    'jupiter': {p.upper(): f'*{PLANETS_MAP["JUPITER"]} در {SIGNS_MAP[p.upper()]}:* خوش‌بینی و رشد شما به شیوه این برج ابراز می‌شود.' for p in SIGNS_MAP},
    'saturn': {p.upper(): f'*{PLANETS_MAP["SATURN"]} در {SIGNS_MAP[p.upper()]}:* درس‌ها و مسئولیت‌های شما به شیوه این برج ساختار می‌یابد.' for p in SIGNS_MAP},
    'uranus': {p.upper(): f'*{PLANETS_MAP["URANUS"]} در {SIGNS_MAP[p.upper()]}:* نوآوری و تغییرات ناگهانی نسل شما به شیوه این برج است.' for p in SIGNS_MAP},
    'neptune': {p.upper(): f'*{PLANETS_MAP["NEPTUNE"]} در {SIGNS_MAP[p.upper()]}:* آرمان‌ها، شهود و ابهام نسل شما به شیوه این برج است.' for p in SIGNS_MAP},
    'pluto': {p.upper(): f'*{PLANETS_MAP["PLUTO"]} در {SIGNS_MAP[p.upper()]}:* تحول، قدرت و مرگ/تولد دوباره نسل شما به شیوه این برج است.' for p in SIGNS_MAP},
    'true_node': {
        'ARIES': '*مسیر تکاملی شما متمرکز بر ایجاد یک هویت مستقل و قاطع است. باید خود را بدون وابستگی ابراز کنید.*',
        'LIBRA': '*مسیر تکاملی شما در روابط یک به یک و شراکت‌ها تعریف می‌شود. باید بیاموزید که چگونه در روابط، برابر و هماهنگ باشید.*',
        'CANCER': '*مسیر تکاملی شما بر ایجاد امنیت عاطفی در خانه، خانواده و ریشه‌های درونی متمرکز است.*',
        'CAPRICORN': '*مسیر تکاملی شما به سمت موفقیت عمومی، جاه‌طلبی‌های حرفه‌ای و دستاوردهای اجتماعی است.*',
        'LEO': '*مسیر تکاملی شما متمرکز بر رهبری، خلاقیت و مرکز توجه بودن است.*',
        'AQUARIUS': '*مسیر تکاملی شما، استقلال فکری، کار گروهی و نوآوری اجتماعی است.*',
        'VIRGO': '*مسیر تکاملی شما بر خدمت، بهبود کارایی، نظم و سلامت روزمره متمرکز است.*',
        'PISCES': '*مسیر تکاملی شما بر معنویت، خلوت، کمک به افراد ضعیف و رها کردن نفس است.*',
        'TAURUS': '*مسیر تکاملی شما بر ایجاد ارزش‌های شخصی، ثبات مالی و اتکا به منابع خود است.*',
        'SCORPIO': '*مسیر تکاملی شما بر تحول عمیق، مدیریت بحران و اعتماد به قدرت درونی متمرکز است.*',
        'GEMINI': '*مسیر تکاملی شما بر یادگیری، ارتباطات روزمره، آموزش‌های کوتاه و محیط نزدیک متمرکز است.*',
        'SAGITTARIUS': '*مسیر تکاملی شما بر فلسفه، جستجوی حقیقت، آموزش عالی و سفرهای دور است.*',
    },
}

# 3. تفسیر سیارات در خانه‌ها (Planets in Houses)
PLANET_IN_HOUSE_INTERPRETATIONS: Dict[int, Dict[str, str]] = {
    1: {p.lower(): f'*{PLANETS_MAP.get(p, p)} در خانه اول (شخصیت):* نشان می‌دهد که انرژی این سیاره چگونه در شخصیت، ظاهر و شیوه ابراز وجود شما نمود پیدا می‌کند.' for p in PLANETS_MAP},
    2: {p.lower(): f'*{PLANETS_MAP.get(p, p)} در خانه دوم (مالکیت):* تأثیر این سیاره بر منابع مالی، درآمد و سیستم ارزش‌های شخصی شماست.' for p in PLANETS_MAP},
    3: {p.lower(): f'*{PLANETS_MAP.get(p, p)} در خانه سوم (ارتباطات):* تأثیر بر نحوه ارتباط برقرار کردن، تفکر، یادگیری، و ارتباط با محیط نزدیک.' for p in PLANETS_MAP},
    4: {p.lower(): f'*{PLANETS_MAP.get(p, p)} در خانه چهارم (خانواده و ریشه‌ها):* تأثیر این سیاره بر ریشه‌ها، خانه، خانواده، امنیت عاطفی و گذشته.' for p in PLANETS_MAP},
    5: {p.lower(): f'*{PLANETS_MAP.get(p, p)} در خانه پنجم (خلاقیت و عشق):* تأثیر بر خلاقیت، عشق‌های رمانتیک، فرزندان، ریسک‌پذیری و سرگرمی.' for p in PLANETS_MAP},
    6: {p.lower(): f'*{PLANETS_MAP.get(p, p)} در خانه ششم (کار و سلامت):* تأثیر بر سلامت، روتین‌های روزانه، کارمندان (زیردستان) و خدمات‌رسانی.' for p in PLANETS_MAP},
    7: {p.lower(): f'*{PLANETS_MAP.get(p, p)} در خانه هفتم (روابط جدی):* تأثیر بر ازدواج، روابط جدی یک به یک، قراردادها و دشمنان آشکار.' for p in PLANETS_MAP},
    8: {p.lower(): f'*{PLANETS_MAP.get(p, p)} در خانه هشتم (تغییر و منابع مشترک):* تأثیر بر امور مالی مشترک (ارث، شراکت)، دگردیسی، جنسیت و مرگ.' for p in PLANETS_MAP},
    9: {p.lower(): f'*{PLANETS_MAP.get(p, p)} در خانه نهم (فلسفه و سفر):* تأثیر بر سفر طولانی، آموزش عالی، فلسفه، دین و باورهای گسترده.' for p in PLANETS_MAP},
    10: {p.lower(): f'*{PLANETS_MAP.get(p, p)} در خانه دهم (شغل و شهرت):* تأثیر بر مسیر شغلی، شهرت و نقش عمومی شما.' for p in PLANETS_MAP},
    11: {p.lower(): f'*{PLANETS_MAP.get(p, p)} در خانه یازدهم (گروه‌ها و آرزوها):* تأثیر بر دوستان، گروه‌ها، امیدها، آرزوها و اهداف جمعی.' for p in PLANETS_MAP},
    12: {p.lower(): f'*{PLANETS_MAP.get(p, p)} در خانه دوازدهم (ناخودآگاه و خلوت):* تأثیر بر زندگی درونی، انزوا، امور پنهان و کارما.' for p in PLANETS_MAP},
}

# 4. تفسیر زوایا (Aspects)
ASPECT_INTERPRETATIONS: Dict[str, Dict[str, str]] = {
    'Conjunction': {
        'SUN_MOON': 'اتصال خورشید و ماه: اتحاد ناخودآگاه و خودآگاه. شخصیتی قوی و متمرکز، اما گاهی اوقات انعطاف‌ناپذیر.',
        'MARS_VENUS': 'اتصال مریخ و زهره: تعادل بین میل (مریخ) و عشق (زهره). جاذبه قوی و انرژی خلاقانه.',
        'SUN_SATURN': 'اتصال خورشید و زحل: نیاز به نظم، انضباط و سخت‌کوشی در زندگی. تأخیر در موفقیت اما پایداری.',
        'MOON_NEPTUNE': 'اتصال ماه و نپتون: شهود قوی، حساسیت زیاد و تمایل به رؤیاپردازی. درگیری با ابهام عاطفی.',
        'SUN_MERCURY': 'اتصال خورشید و عطارد: تمرکز ذهن بر اراده و هویت شخصی. ارتباط قوی بین خودآگاه و منطق.',
        # ... سایر زوایا
    },
    'Square': {
        'SUN_SATURN': 'تربیع خورشید و زحل: چالش‌های هویتی و خودباوری. نیاز به سخت‌کوشی برای رسیدن به اهداف.',
        'MARS_JUPITER': 'تربیع مریخ و مشتری: انرژی و خوش‌بینی بیش از حد. تمایل به زیاده‌روی و ریسک‌پذیری زیاد.',
        'MARS_PLUTO': 'تربیع مریخ و پلوتو: کشمکش شدید بر سر کنترل و قدرت. انرژی بسیار قوی برای عمل و تحول.',
        # ... سایر زوایا
    },
    'Trine': {
        'JUPITER_VENUS': 'تثلیث مشتری و زهره: سعادت بزرگ. شانس، جذابیت اجتماعی و مالی، و نگرش خوش‌بینانه.',
        'MOON_NEPTUNE': 'تثلیث ماه و نپتون: شهود قوی، حساسیت هنری و روانی. همدلی و تخیل غنی.',
        'SUN_MARS': 'تثلیث خورشید و مریخ: انرژی حیاتی بالا، اعتماد به نفس و توانایی عملی کردن اهداف.',
        # ... سایر زوایا
    },
    'Opposition': {
        'SUN_MOON': 'مقابله خورشید و ماه: درگیری درونی بین نیازهای عاطفی (ماه) و خواسته‌های هویتی (خورشید).',
        'SATURN_MARS': 'مقابله زحل و مریخ: کشمکش بین عمل (مریخ) و محدودیت (زحل). نیاز به تعادل بین شتاب و احتیاط.',
        'JUPITER_URANUS': 'مقابله مشتری و اورانوس: تنش بین سنت و نوآوری. هیجانات ناگهانی و غیرقابل پیش‌بینی در امور مالی و فکری.',
        # ... سایر زوایا
    }
}

# 5. تفسیر حاکم چارت در خانه‌ها (Chart Ruler/Ascendant Ruler in House)
# این دیکشنری باید با توجه به حاکم آسندانت پر شود، اما به عنوان یک ساختار کامل حفظ شده است.
RULER_IN_HOUSE_INTERPRETATIONS: Dict[int, Dict[int, str]] = {
    1: { 
        1: '*حاکم چارت در خانه خود: هویت و هدف اصلی شما در هویت شخصی، ظاهر و خودابرازگری ریشه دارد. شما فردی متکی به نفس هستید.*',
        2: '*حاکم چارت در خانه دوم: انرژی و هویت اصلی شما متمرکز بر منابع مالی، درآمد و سیستم ارزش‌های شخصی شماست. امنیت مالی برای شما تعیین‌کننده است.*',
        7: '*حاکم چارت در خانه هفتم: تمرکز انرژی و هویت شما در حوزه‌ی خانه هفتم (روابط و ازدواج) قرار دارد، که بر تمامی شخصیت شما حاکم است. شما هویت خود را از طریق دیگران پیدا می‌کنید.*',
        10: '*حاکم چارت در خانه دهم: هویت و هدف اصلی شما در جاه‌طلبی، شغل، جایگاه اجتماعی و موفقیت عمومی است. شما فردی هدفمند و متمرکز بر دستاوردها هستید.*',
        # ... سایر خانه‌ها (باید بر اساس حاکم آسندانت و خانه محاسبه و تفسیر شوند)
    },
}


# ====================================================================
# تابع اصلی تولید تفسیر
# ====================================================================

def interpret_natal_chart(chart_data: Dict[str, Any]) -> str:
    """
    داده‌های چارت تولد را گرفته و یک تفسیر جامع فارسی تولید می‌کند.
    """
    
    interpretations = []

    # 1. عنوان و اطلاعات اولیه
    city_name = chart_data.get('city_name', 'نامشخص')
    date_str_fa = chart_data.get('birth_date_jalali', 'تاریخ نامشخص')
    time_str_fa = chart_data.get('birth_time_str', 'زمان نامشخص')
    
    header = f"⭐️ **تفسیر چارت تولد** ⭐️\n"
    header += f"**محل تولد:** {city_name} | **تاریخ:** {date_str_fa} | **زمان:** {time_str_fa}\n\n"
    
    
    # 2. تفسیر Ascendant (طالع - شخصیت ظاهری)
    interpretations.append("\n*--- طالع (Ascendant) و هویت ظاهری ---*")
    asc_sign = chart_data['houses']['asc_sign'].upper()
    asc_interp = ASCENDANT_INTERPRETATIONS.get(asc_sign, f"**طالع در {SIGNS_MAP.get(asc_sign, asc_sign)}:** تفسیر موجود نیست.")
    interpretations.append(f"**طالع:** {asc_interp}")

    # 3. تفسیر سیارات اصلی در برج و خانه
    interpretations.append("\n*--- تفسیر سیارات اصلی در برج و خانه ---*")
    
    for planet_name in ['sun', 'moon', 'mercury', 'venus', 'mars']:
        if planet_name in chart_data['planets']:
            data = chart_data['planets'][planet_name]
            p_sign = data['sign'].upper()
            p_house = data['house']
            p_fa = PLANETS_MAP.get(planet_name.upper(), planet_name.title())
            
            # تفسیر در برج
            sign_interp = PLANET_IN_SIGN_INTERPRETATIONS.get(planet_name, {}).get(p_sign, f"*{p_fa} در {SIGNS_MAP.get(p_sign, p_sign)}:* تفسیر موجود نیست.")
            
            # تفسیر در خانه
            house_interp = PLANET_IN_HOUSE_INTERPRETATIONS.get(p_house, {}).get(planet_name, f"*{p_fa} در خانه {p_house}:* فعالیت این سیاره در این حوزه زندگی متمرکز است.")

            # اضافه کردن به لیست
            interpretations.append(f"\n{sign_interp}\n{house_interp}")
            
    # 4. تفسیر سیارات بیرونی و گره‌ها (فقط در خانه)
    interpretations.append("\n*--- تفسیر سیارات بیرونی و گره‌ها ---*")
    for planet_name in ['jupiter', 'saturn', 'uranus', 'neptune', 'pluto', 'true_node']:
        if planet_name in chart_data['planets']:
            data = chart_data['planets'][planet_name]
            p_house = data['house']
            p_fa = PLANETS_MAP.get(planet_name.upper(), planet_name.title())

            # تفسیر در خانه (یا گره در برج برای گره‌ها)
            if planet_name == 'true_node':
                 p_sign = data['sign'].upper()
                 node_interp = PLANET_IN_SIGN_INTERPRETATIONS.get('true_node', {}).get(p_sign, f"*{p_fa} در {SIGNS_MAP.get(p_sign, p_sign)}:* مسیر تکاملی روح شما در این حوزه است.")
                 interpretations.append(f"\n{node_interp}")
            else:
                 house_interp = PLANET_IN_HOUSE_INTERPRETATIONS.get(p_house, {}).get(planet_name, f"*{p_fa} در خانه {p_house}:* تأثیر این سیاره نسلی/اجتماعی بر این حوزه زندگی است.")
                 interpretations.append(f"\n{house_interp}")


    # 5. تفسیر زوایا (Aspects)
    aspects_list = chart_data.get('aspects', [])
    if aspects_list:
        aspects_interp = ["\n*--- زوایای اصلی (Aspects) ---*"]
        
        for aspect in aspects_list:
            p1 = aspect['p1'].upper().replace(" ", "_")
            p2 = aspect['p2'].upper().replace(" ", "_")
            aspect_name = aspect['aspect']
            
            key1 = f"{p1}_{p2}"
            key2 = f"{p2}_{p1}"
            
            interp = ASPECT_INTERPRETATIONS.get(aspect_name, {}).get(key1)
            if not interp:
                interp = ASPECT_INTERPRETATIONS.get(aspect_name, {}).get(key2)
                
            if interp:
                aspects_interp.append(f"  • {interp} (اُرب: {aspect['orb']:.2f}°)")
            else:
                aspect_fa = ASPECTS_MAP.get(aspect_name.upper(), aspect_name)
                p1_fa = PLANETS_MAP.get(p1, p1.title())
                p2_fa = PLANETS_MAP.get(p2, p2.title())
                aspects_interp.append(f"  • {aspect_fa} بین {p1_fa} و {p2_fa} (اُرب: {aspect['orb']:.2f}°): این دو نیرو در حال تعامل هستند.")
                
        interpretations.extend(aspects_interp)
        
    # 6. خلاصه‌ای از توزیع عناصر و کیفیت‌ها
    element_summary = chart_data.get('summary', {}).get('elements', {})
    quality_summary = chart_data.get('summary', {}).get('qualities', {})
    
    summary_text = ["\n*--- توزیع عناصر و کیفیت‌ها ---*"]
    
    elements_fa = [f"{ELEMENT_MAP.get(e, e)}: {c:.2f} سیاره" for e, c in element_summary.items()]
    summary_text.append(f"  • عناصر: {'، '.join(elements_fa)}")
    
    qualities_fa = [f"{QUALITY_MAP.get(q, q)}: {c:.2f} سیاره" for q, c in quality_summary.items()]
    summary_text.append(f"  • کیفیت‌ها: {'، '.join(qualities_fa)}")

    interpretations.extend(summary_text)

    # 7. ترکیب نهایی
    final_output = "\n".join(interpretations)
    return header + final_output

