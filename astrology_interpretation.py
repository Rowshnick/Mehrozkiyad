# ----------------------------------------------------------------------
# astrology_interpretation.py - ูุงฺูู ุชูุณุฑ ฺุงุฑุช ุชููุฏ (ูุณุฎู ุชุฏุงูุน)
# ----------------------------------------------------------------------

from typing import Dict, Any

# --- [ุซุงุจุชโูุง ู ุชุนุงุฑู] ---
ZODIAC_SIGNS = {
    0: "ุญูู (Aries)", 30: "ุซูุฑ (Taurus)", 60: "ุฌูุฒุง (Gemini)", 90: "ุณุฑุทุงู (Cancer)",
    120: "ุงุณุฏ (Leo)", 150: "ุณูุจูู (Virgo)", 180: "ูุฒุงู (Libra)", 210: "ุนูุฑุจ (Scorpio)",
    240: "ููุณ (Sagittarius)", 270: "ุฌุฏ (Capricorn)", 300: "ุฏูู (Aquarius)", 330: "ุญูุช (Pisces)"
}

HOUSE_NAMES = {
    1: "ุฎุงูู ุงูู (ุดุฎุตุช ู ุธุงูุฑ)", 2: "ุฎุงูู ุฏูู (ูุงู ู ุงุฑุฒุดโูุง)", 
    3: "ุฎุงูู ุณูู (ุงุฑุชุจุงุทุงุช ู ุงุฏฺฏุฑ)", 4: "ุฎุงูู ฺูุงุฑู (ุฎุงูู ู ุฎุงููุงุฏู)",
    5: "ุฎุงูู ูพูุฌู (ุฎูุงูุช ู ุนุดู)", 6: "ุฎุงูู ุดุดู (ุณูุงูุช ู ฺฉุงุฑ ุฑูุฒูุฑู)",
    7: "ุฎุงูู ููุชู (ุฑูุงุจุท ู ุงุฒุฏูุงุฌ)", 8: "ุฎุงูู ูุดุชู (ุชุบุฑ ู ููุงุจุน ูุดุชุฑฺฉ)",
    9: "ุฎุงูู ููู (ุณูุฑ ู ููุณูู)", 10: "ุฎุงูู ุฏูู (ุดุบู ู ุดูุฑุช)",
    11: "ุฎุงูู ุงุฒุฏูู (ฺฏุฑููโูุง ู ุขุฑุฒููุง)", 12: "ุฎุงูู ุฏูุงุฒุฏูู (ุฎููุช ู ูุงุฎูุฏุขฺฏุงู)"
}

# --- [ุชูุงุจุน ฺฉูฺฉ] ---

def get_sign_and_degree(degree: float) -> str:
    """ุฏุฑุฌู ุฑุง ุจู ูุฑูุช '15 ุฏุฑุฌู ุฌูุฒุง' ุชุจุฏู ูโฺฉูุฏ."""
    
    degree = degree % 360 
    start_degrees = sorted(ZODIAC_SIGNS.keys())
    
    sign_start_degree = 0
    for start_deg in start_degrees:
        if degree >= start_deg:
            sign_start_degree = start_deg
        else:
            break
            
    sign_name = ZODIAC_SIGNS[sign_start_degree]
    degree_in_sign = degree - sign_start_degree
    
    deg_int = int(degree_in_sign)
    min_int = int((degree_in_sign - deg_int) * 60)
    
    return f"{deg_int}ยฐ {min_int}' {sign_name}"

def get_house_of_degree(degree: float, cusps: Dict[int, float]) -> str:
    """ูููุนุช ฺฉ ุฏุฑุฌู ูุดุฎุต ุฑุง ุฏุฑ ฺุงุฑุช ุฎุงููโูุง ูพุฏุง ูโฺฉูุฏ."""
    
    degree = degree % 360
    
    # ๐ก ุงุทููุงู ุงุฒ ูุฌูุฏ cusps ฺฉุงู
    if len(cusps) < 12:
        return "N/A (Cusps Missing)" 
    
    for i in range(1, 13):
        start_cusp = cusps.get(i, 0.0)
        end_cusp = cusps.get(i % 12 + 1, 0.0) 
        
        if start_cusp < end_cusp:
            if start_cusp <= degree < end_cusp:
                return HOUSE_NAMES[i]
        else:
            if degree >= start_cusp or degree < end_cusp:
                return HOUSE_NAMES[i]
                
    return "N/A (Logic Error)"

# --- [ููุทู ุงุตู ุชูุณุฑ] ---

def interpret_natal_chart(chart_data: Dict[str, Any]) -> str:
    """ุชูุณุฑ ุงุตู ฺุงุฑุช ุฑุง ุจุฑ ุงุณุงุณ ุณุงุฑุงุช ู ุฎุงููโูุง ุงุฌุงุฏ ูโฺฉูุฏ."""
    
    # ๐ก ฺฏุงู ณ: ุจุฑุฑุณ ุฎุทุง ูุญุงุณุจู ุฎุงููโูุง ุฏุฑ ุณุทุญ ูุงฺูู ุชูุณุฑ
    houses_data = chart_data.get('houses', {})
    houses_error = houses_data.get('error')
    
    if houses_error:
        # ุงฺฏุฑ ุฎุทุง ุฏุฑ ูุญุงุณุจู ุฎุงููโูุง ุฑุฎ ุฏุงุฏู ุจุงุดุฏุ ุจูุงูุงุตูู ุขู ุฑุง ฺฏุฒุงุฑุด ุฏูุฏ.
        return (
            "โ **ุฎุทุง ุจุญุฑุงู ุฏุฑ ูุญุงุณุจู ุฎุงููโูุง ู ุขุณูุฏุงูุช**:\n"
            f"ูุชุฃุณูุงูู ูุญุงุณุจุงุช ูููุนุช ุฎุงููโูุง ููููุชโุขูุฒ ูุจูุฏ.\n"
            f"ุฌุฒุฆุงุช ุฎุทุง: `{houses_error}`\n"
            "ุชูุณุฑ ุจุฑ ุงุณุงุณ ูููุนุช ุฎุงููโูุง (House Placement) ุงูุฌุงู ูุดุฏ ู ุงุฒ ููุงุฏุฑ ูพุดโูุฑุถ ุงุณุชูุงุฏู ุดุฏ."
        )

    # ุงฺฏุฑ ูุญุงุณุจู ุฎุงููโูุง ูููู ุจูุฏ:
    
    planets = chart_data['planets']
    cusps = houses_data.get('cusps') # ุงุณุชูุงุฏู ุงูู
    
    # --- 1. ุชูุณุฑ ุณุงุฑุงุช ุงุตู (Sun, Moon, Asc) ---
    ascendant_degree = houses_data.get('ascendant', 0.0)
    ascendant_sign = get_sign_and_degree(ascendant_degree)

    sun_degree = planets['sun']['degree']
    sun_sign = get_sign_and_degree(sun_degree)

    moon_degree = planets['moon']['degree']
    moon_sign = get_sign_and_degree(moon_degree)
    
    # ูพุฏุง ฺฉุฑุฏู ุฎุงูู ุฎูุฑุดุฏ
    sun_house = get_house_of_degree(sun_degree, cusps)

    interpretation = [
        "**ุชูุณุฑ ุงููู ฺุงุฑุช ุชููุฏ**",
        "------------------------------------",
        f"๐ **ุจุฑุฌ ุฎูุฑุดุฏ (ููุช ู ุฐุงุช):** {sun_sign}",
        f"    *ุชูุณุฑ ฺฉูุชุงู:* ุฎูุฑุดุฏ ุฏุฑ ุจุฑุฌ {sun_sign.split()[0]} ูุดุงูโุฏููุฏู ููุชุ ูุฏุฑุช ุงุฑุงุฏู ู ูุณุฑ ุฒูุฏฺฏ ุดูุง ุงุณุช.",
        f"    *ูููุนุช ุฏุฑ ุฎุงูู:* {sun_house}",
        f"    *ุชุฃุซุฑ:* ุงู ุฌุงฺฏุฑ ุจุฑ ูุญูู ุจุฑูุฒ ุฎูุงูุช ู ูุฑฺฉุฒุช ุดูุง ุฏุฑ ุญูุฒูโ {sun_house} ุชูุฑฺฉุฒ ุฏุงุฑุฏ.",
        "",
        f"๐ **ุจุฑุฌ ูุงู (ุงุญุณุงุณุงุช ู ูุงุฎูุฏุขฺฏุงู):** {moon_sign}",
        f"    *ุชูุณุฑ ฺฉูุชุงู:* ูุงู ุฏุฑ ุจุฑุฌ {moon_sign.split()[0]} ูุดุงูโุฏููุฏู ูุงุฒูุง ุนุงุทูุ ูุงฺฉูุดโูุง ุบุฑุฒ ู ุงููุช ุฏุฑูู ุดูุง ุงุณุช.",
        "",
        f"โฌ๏ธ **ุขุณูุฏุงูุช (ุดุฎุตุช ุธุงูุฑ ู ูุญูู ุจุฑุฎูุฑุฏ):** {ascendant_sign}",
        f"    *ุชูุณุฑ ฺฉูุชุงู:* ุขุณูุฏุงูุช (ุจุฑุฌ ุจุงูุง ุฑููุฏู) ุฏุฑ {ascendant_sign.split()[0]} ุชุตูุฑ ุงุณุช ฺฉู ุดูุง ุจู ุฌูุงู ุงุฑุงุฆู ูโุฏูุฏ ู ุงููู ูุงฺฉูุด ุดูุง ุจู ูุญุท ุงุณุช.",
        "",
        "--- **ุณุงุฑ ุฌุงฺฏุฑโูุง** ---",
    ]
    
    # --- 2. ุฌุงฺฏุฑ ูุฑุฎ ู ูููุณ ---
    mars_degree = planets['mars']['degree']
    mars_sign = get_sign_and_degree(mars_degree)
    mars_house = get_house_of_degree(mars_degree, cusps)
    
    interpretation.append(f"๐ฅ **ูุฑุฎ (ุงูุฑฺ ู ุนูู):** {mars_sign} ุฏุฑ {mars_house}")
    interpretation.append(f"    *ุชุฃุซุฑ:* ูุญูู ุงุจุฑุงุฒ ุฎุดูุ ุงูุฑฺ ู ุงูุฏุงู ุดูุง ุฏุฑ ุญูุฒูโ {mars_house} ุงูุฌุงู ูโุดูุฏ.")
    
    interpretation.append("")
    interpretation.append("**ุชูุฌู:** ุงู ุชูุณุฑ ุจุณุงุฑ ุงุจุชุฏุง ุงุณุช ู ูุงุฒ ุจู ุจุฑุฑุณ ุฒูุงุง ู ุญุงฺฉูุช ุณุงุฑุงุช ุจุฑุง ุฏูุช ุจุดุชุฑ ุฏุงุฑุฏ.")

    return "\n".join(interpretation)
