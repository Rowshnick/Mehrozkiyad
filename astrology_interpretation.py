# ----------------------------------------------------------------------
# astrology_interpretation.py - ูุงฺูู ุชูุณุฑ ฺุงุฑุช ุชููุฏ
# ----------------------------------------------------------------------

from typing import Dict, Any

# --- [ุซุงุจุชโูุง ููุฑุฏ ูุงุฒ ุจุฑุง ุชูุณุฑ] ---

# ูฺฏุงุดุช ุฏุฑุฌู ุดุฑูุน ูุฑ ุจุฑุฌ ุจู ูุงู ุขู (ูุงุฑุณ ู ุงูฺฏูุณ)
ZODIAC_SIGNS = {
    0: "ุญูู (Aries)", 30: "ุซูุฑ (Taurus)", 60: "ุฌูุฒุง (Gemini)", 90: "ุณุฑุทุงู (Cancer)",
    120: "ุงุณุฏ (Leo)", 150: "ุณูุจูู (Virgo)", 180: "ูุฒุงู (Libra)", 210: "ุนูุฑุจ (Scorpio)",
    240: "ููุณ (Sagittarius)", 270: "ุฌุฏ (Capricorn)", 300: "ุฏูู (Aquarius)", 330: "ุญูุช (Pisces)"
}

# ูุงู ุฎุงููโูุง (ุจุฑุง ุฎูุงูุง ุจุดุชุฑ)
HOUSE_NAMES = {
    1: "ุฎุงูู ุงูู (ุดุฎุตุช ู ุธุงูุฑ)", 2: "ุฎุงูู ุฏูู (ูุงู ู ุงุฑุฒุดโูุง)", 
    3: "ุฎุงูู ุณูู (ุงุฑุชุจุงุทุงุช ู ุงุฏฺฏุฑ)", 4: "ุฎุงูู ฺูุงุฑู (ุฎุงูู ู ุฎุงููุงุฏู)",
    5: "ุฎุงูู ูพูุฌู (ุฎูุงูุช ู ุนุดู)", 6: "ุฎุงูู ุดุดู (ุณูุงูุช ู ฺฉุงุฑ ุฑูุฒูุฑู)",
    7: "ุฎุงูู ููุชู (ุฑูุงุจุท ู ุงุฒุฏูุงุฌ)", 8: "ุฎุงูู ูุดุชู (ุชุบุฑ ู ููุงุจุน ูุดุชุฑฺฉ)",
    9: "ุฎุงูู ููู (ุณูุฑ ู ููุณูู)", 10: "ุฎุงูู ุฏูู (ุดุบู ู ุดูุฑุช)",
    11: "ุฎุงูู ุงุฒุฏูู (ฺฏุฑููโูุง ู ุขุฑุฒููุง)", 12: "ุฎุงูู ุฏูุงุฒุฏูู (ุฎููุช ู ูุงุฎูุฏุขฺฏุงู)"
}

# --- [ุชูุงุจุน ฺฉูฺฉ] ---

def get_sign_and_degree(degree: float) -> str:
    """ุฏุฑุฌู ุฑุง ุจู ูุฑูุช '15 ุฏุฑุฌู ุฌูุฒุง' ุชุจุฏู ูโฺฉูุฏ."""
    
    # ุงุทููุงู ุงุฒ ูุฑุงุฑฺฏุฑ ุฏุฑุฌู ุฏุฑ ูุญุฏูุฏู 0 ุชุง 360
    degree = degree % 360 
    
    # ูพุฏุง ฺฉุฑุฏู ุจุฑุฌ
    start_degrees = sorted(ZODIAC_SIGNS.keys())
    
    sign_start_degree = 0
    for start_deg in start_degrees:
        if degree >= start_deg:
            sign_start_degree = start_deg
        else:
            break
            
    sign_name = ZODIAC_SIGNS[sign_start_degree]
    
    # ูุญุงุณุจู ุฏุฑุฌู ุฏุงุฎู ุจุฑุฌ
    degree_in_sign = degree - sign_start_degree
    
    # ฺฏุฑุฏ ฺฉุฑุฏู ุจุฑุง ููุงุด ุจูุชุฑ
    deg_int = int(degree_in_sign)
    min_int = int((degree_in_sign - deg_int) * 60)
    
    return f"{deg_int}ยฐ {min_int}' {sign_name}"

def get_house_of_degree(degree: float, cusps: Dict[int, float]) -> str:
    """ูููุนุช ฺฉ ุฏุฑุฌู ูุดุฎุต ุฑุง ุฏุฑ ฺุงุฑุช ุฎุงููโูุง ูพุฏุง ูโฺฉูุฏ."""
    
    degree = degree % 360
    
    # ุงุฒ cusp ุฎุงูู ุดุฑูุน (1) ุชุง cusp ุฎุงูู ุจุนุฏ (2) ุฎุงูู 1 ุงุณุช.
    # ุจู ุฏูู ูพฺุฏฺฏ ุนุจูุฑ ุงุฒ 0/360ุ ุจูุชุฑ ุงุณุช ุงุฒ ุชุงุจุนโูุง ุฏุงุฎู swisseph ุงุณุชูุงุฏู ุดูุฏ.
    # ุงูุง ฺูู ูุง ุจู se ุฏุณุชุฑุณ ูุฏุงุฑูุ ฺฉ ููุทู ุณุงุฏู ุงุฌุงุฏ ูโฺฉูู.
    
    # ุชุจุฏู ุฏฺฉุดูุฑ cusps ุจู ูุณุช ูุฑุชุจ ุดุฏู
    house_cusps = sorted(cusps.items()) # ูุณุช (ุดูุงุฑู ุฎุงูู, ุฏุฑุฌู)
    
    # ุจุฑุง ูุฑ ุฎุงููุ ุจุฑุฑุณ ูโฺฉูู ฺฉู ุฏุฑุฌู ุจู cusp ุดุฑูุน ู cusp ุจุนุฏ ุจุงุดุฏ
    for i in range(1, 13):
        
        # ุขุณุชุงูู ุดุฑูุน (cusp ุฎุงูู ูุนู)
        start_cusp = cusps[i] 
        # ุขุณุชุงูู ูพุงุงู (cusp ุฎุงูู ุจุนุฏ)
        end_cusp = cusps[i % 12 + 1] # i+1 ุง 1 ุฏุฑ ููุฑุฏ ุฎุงูู 12
        
        # ุญุงูุช ุนุงุฏ: 
        if start_cusp < end_cusp:
            if start_cusp <= degree < end_cusp:
                return HOUSE_NAMES[i]
        # ุญุงูุช ุนุจูุฑ ุงุฒ 360 ุจู 0 (ูุซูุง ุงุฒ ููุณ ณตฐ ุจู ุญูู ฑฐ)
        else:
            if degree >= start_cusp or degree < end_cusp:
                return HOUSE_NAMES[i]
                
    return "ูุงูุดุฎุต" # ุงฺฏุฑ ุฎุทุง ุฑุฎ ุฏุงุฏ

# --- [ููุทู ุงุตู ุชูุณุฑ] ---

def interpret_natal_chart(chart_data: Dict[str, Any]) -> str:
    """ุชูุณุฑ ุงุตู ฺุงุฑุช ุฑุง ุจุฑ ุงุณุงุณ ุณุงุฑุงุช ู ุฎุงููโูุง ุงุฌุงุฏ ูโฺฉูุฏ."""
    
    planets = chart_data['planets']
    cusps = chart_data['houses']['cusps']
    
    # --- 1. ุชูุณุฑ ุณุงุฑุงุช ุงุตู (Sun, Moon, Asc) ---
    ascendant_degree = chart_data['houses']['ascendant']
    ascendant_sign = get_sign_and_degree(ascendant_degree)

    sun_degree = planets['sun']['degree']
    sun_sign = get_sign_and_degree(sun_degree)

    moon_degree = planets['moon']['degree']
    moon_sign = get_sign_and_degree(moon_degree)
    
    # ูพุฏุง ฺฉุฑุฏู ุฎุงูู ุฎูุฑุดุฏ
    sun_house = get_house_of_degree(sun_degree, cusps)

    interpretation = [
        "**ุชูุณุฑ ุงููู ฺุงุฑุช ุชููุฏ**",
        "------------------------------------",
        f"๐ **ุจุฑุฌ ุฎูุฑุดุฏ (ููุช ู ุฐุงุช):** {sun_sign}",
        f"    *ุชูุณุฑ ฺฉูุชุงู:* ุฎูุฑุดุฏ ุฏุฑ ุจุฑุฌ {sun_sign.split()[0]} ูุดุงูโุฏููุฏู ููุชุ ูุฏุฑุช ุงุฑุงุฏู ู ูุณุฑ ุฒูุฏฺฏ ุดูุง ุงุณุช.",
        f"    *ูููุนุช ุฏุฑ ุฎุงูู:* {sun_house}",
        f"    *ุชุฃุซุฑ:* ุงู ุฌุงฺฏุฑ ุจุฑ ูุญูู ุจุฑูุฒ ุฎูุงูุช ู ูุฑฺฉุฒุช ุดูุง ุฏุฑ ุญูุฒูโ {sun_house} ุชูุฑฺฉุฒ ุฏุงุฑุฏ.",
        "",
        f"๐ **ุจุฑุฌ ูุงู (ุงุญุณุงุณุงุช ู ูุงุฎูุฏุขฺฏุงู):** {moon_sign}",
        f"    *ุชูุณุฑ ฺฉูุชุงู:* ูุงู ุฏุฑ ุจุฑุฌ {moon_sign.split()[0]} ูุดุงูโุฏููุฏู ูุงุฒูุง ุนุงุทูุ ูุงฺฉูุดโูุง ุบุฑุฒ ู ุงููุช ุฏุฑูู ุดูุง ุงุณุช.",
        "",
        f"โฌ๏ธ **ุขุณูุฏุงูุช (ุดุฎุตุช ุธุงูุฑ ู ูุญูู ุจุฑุฎูุฑุฏ):** {ascendant_sign}",
        f"    *ุชูุณุฑ ฺฉูุชุงู:* ุขุณูุฏุงูุช (ุจุฑุฌ ุจุงูุง ุฑููุฏู) ุฏุฑ {ascendant_sign.split()[0]} ุชุตูุฑ ุงุณุช ฺฉู ุดูุง ุจู ุฌูุงู ุงุฑุงุฆู ูโุฏูุฏ ู ุงููู ูุงฺฉูุด ุดูุง ุจู ูุญุท ุงุณุช.",
        "",
        "--- **ุณุงุฑ ุฌุงฺฏุฑโูุง** ---",
    ]
    
    # --- 2. ุฌุงฺฏุฑ ูุฑุฎ ู ูููุณ (ูุซุงู ุจุฑุง ุณุงุฑุงุช ุฏฺฏุฑ) ---
    
    mars_degree = planets['mars']['degree']
    mars_sign = get_sign_and_degree(mars_degree)
    mars_house = get_house_of_degree(mars_degree, cusps)
    
    interpretation.append(f"๐ฅ **ูุฑุฎ (ุงูุฑฺ ู ุนูู):** {mars_sign} ุฏุฑ {mars_house}")
    interpretation.append(f"    *ุชุฃุซุฑ:* ูุญูู ุงุจุฑุงุฒ ุฎุดูุ ุงูุฑฺ ู ุงูุฏุงู ุดูุง ุฏุฑ ุญูุฒูโ {mars_house} ุงูุฌุงู ูโุดูุฏ.")
    
    interpretation.append("")
    interpretation.append("**ุชูุฌู:** ุงู ุชูุณุฑ ุจุณุงุฑ ุงุจุชุฏุง ุงุณุช. ุชูุณุฑ ุฏูู ูุงุฒ ุจู ุจุฑุฑุณ ุฒูุงุง (Aspects)ุ ุฏุฑุฌุงุช ุญุงุช ู ุญุงฺฉูุช ุณุงุฑุงุช ุฏุงุฑุฏ.")

    return "\n".join(interpretation)

# --- [ูุญูู ุงุณุชูุงุฏู] ---
# ูุฑุถ ฺฉูุฏ chart_data ุฎุฑูุฌ calculate_natal_chart ุงุณุช.
# result_text = interpret_natal_chart(chart_data)
# print(result_text)
